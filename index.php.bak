<?php
	$msc=include("/var/www/ServiceTags/mysqlConnect.php");
	if ($msc->connect_errno) {
    		$postResult = "Failed to connect to MySQL: (".$msc->connect_errno.") ".$msc->connect_error;
	}
	//echo $msc->host_info . "\n";
	if(ISSET($_GET['tag']) && strlen($_GET['tag'])>0){
		$tag = strtoupper($_GET['tag']);
		$query = "SELECT COUNT('UniqueID') AS 'TagFound' FROM TagList WHERE ServiceTag='".$tag."';";
		$result = $msc->query($query);
		while ($row = $result->fetch_assoc()) {
		    	$found = $row['TagFound'];
			if($found==0){
				//Enter it in the table
				$add='INSERT INTO TagList VALUES (NULL,"'.$tag.'","Manual","1");';
				$addResult = $msc->query($add);
				if($addResult==1){
					$postResult = "The Service Tag: <b>".$tag."</b> has been added to the list as a Manual Entry.";
				}
				else{
					$postResult = "The Service Tag: <b>".$tag."</b> has NOT been added to the list due to an SQL Error.";
				}
			}
			else{
				//Check if it was already scanned.
				$query2 = "SELECT Found,WhichList FROM TagList WHERE ServiceTag='".$tag."';";
				$result2 = $msc->query($query2);
				while($row2 = $result2->fetch_assoc()){
					$found2 = $row2['Found'];
					$list2 = $row2['WhichList'];
					if($list2 == "Chatham"){
						$list2 = "a <font color='green'>Chatham Device</font>";
					}
					elseif($list2 == "Other"){
						$list2 = "<font color='red'>NOT A CHATHAM DEVICE</font>";
					}
					else{
						$list2 = "<font color='blue'>Not On Any List</font>";
					}
					//
					if($found2==1){

						$postResult = "The Service Tag: <b>".$tag."</b> is ".$list2." and had been marked as found already.";
					}
					else{
						$add='UPDATE TagList SET Found="1" WHERE ServiceTag="'.$tag.'";';
						$addResult = $msc->query($add);
						if($addResult==1){
							$postResult = "The Service Tag: <b>".$tag."</b> is ".$list2." and has been marked as Found.";
						}
						else{
							$postResult = "The Service Tag: <b>".$tag."</b> is ".$list2." and  has NOT been marked as Found due to an SQL Error.";
						}
					}
				}
			}
		}
	}
?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>Chromebook Service Tag Checker</title>
		<link rel="stylesheet" type="text/css" href="view.css" media="all">
		<script type="text/javascript" src="view.js"></script>
	</head>
	<body id="main_body" onLoad="document.forms.CSTC.tag.focus()">
		<img id="top" src="top.png" alt="">
		<div id="form_container">
			<h1><a>Chromebook Service Tag Checker</a></h1>
			<form name="CSTC" id="CSTC" class="appnitro" method="get" action="index.php">
				<div class="form_description">
					<h2>Chromebook Service Tag Checker</h2>
					<p>This form cross references Service Tags.  Enter a Service Tag to continue.</p>
					<?php
						if(ISSET($postResult)){
							echo("<p><font size='+1'>".$postResult."</font></p>");
						}
					?>
				</div>
				<ul >
					<li id="li_1" >
						<label class="description" for="element_1">Service Tag</label>
						<div>
							<input selected id="tag" name="tag" class="element text small" type="text" maxlength="10" value=""/>
						</div>
					</li>
					<li class="buttons">
						<input type="hidden" name="form_id" value="CSTC" />
						<input id="saveForm" class="button_text" type="submit" name="submit" value="Submit" />
					</li>
				</ul>
			</form>
			<div id="footer">
				Generated by <a href="http://www.phpform.org">pForm</a>
			</div>
		</div>
		<img id="bottom" src="bottom.png" alt="">
	</body>
</html>
